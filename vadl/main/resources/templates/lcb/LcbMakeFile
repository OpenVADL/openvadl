TARGET="[(${namespace})]"

CMAKE_CXX_STANDARD="14"
LLVM_SOURCE_PATH="llvm-final"

ifndef LLVM_PARALLEL_COMPILE_JOBS
		LLVM_PARALLEL_COMPILE_JOBS=10
endif
ifndef LLVM_PARALLEL_LINK_JOBS
		LLVM_PARALLEL_LINK_JOBS=2
endif
ifndef LLVM_ENABLE_PROJECTS
		LLVM_ENABLE_PROJECTS="clang"
endif
ifndef LLVM_SOURCE_PATH
		$(error LLVM_SOURCE_PATH is not set)
endif
ifndef LLVM_CMAKE_BUILD_TYPE
		LLVM_CMAKE_BUILD_TYPE="Debug"
endif
ifndef LLVM_ENABLE_ASSERTIONS
		LLVM_ENABLE_ASSERTIONS=Off
endif

LLVM_CCACHE_BUILD=0
LLVM_CCACHE_DIR=
LLVM_CCACHE_MAXSIZE=
ifdef LLVM_CCACHE_PATH
		LLVM_CCACHE_BUILD=1
		LLVM_CCACHE_DIR=$(LLVM_CCACHE_PATH)

		LLVM_CCACHE_MAXSIZE="5.0G"
		ifdef LLVM_CCACHE_SIZE
				LLVM_CCACHE_MAXSIZE=$(LLVM_CCACHE_SIZE)
		endif
endif

default: build

.PHONY: build

build:
		git clone https://github.com/llvm/llvm-project --depth=1 -b llvmorg-17.0.6 $(LLVM_SOURCE_PATH) || true
		cp -r ./llvm/* $(LLVM_SOURCE_PATH)/llvm
		mkdir -p $(LLVM_SOURCE_PATH)/build
		cmake -GNinja -S $(LLVM_SOURCE_PATH)/llvm -B $(LLVM_SOURCE_PATH)/build \
					-DCMAKE_BUILD_TYPE=$(LLVM_CMAKE_BUILD_TYPE) \
					-DCMAKE_CXX_STANDARD=$(CMAKE_CXX_STANDARD) \
					-DLLVM_ENABLE_PROJECTS="$(LLVM_ENABLE_PROJECTS)" \
					-DLLVM_TARGETS_TO_BUILD="" \
					-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="$(TARGET)" \
					-DLLVM_PARALLEL_COMPILE_JOBS=$(LLVM_PARALLEL_COMPILE_JOBS) \
					-DLLVM_PARALLEL_LINK_JOBS=$(LLVM_PARALLEL_LINK_JOBS) \
					-DLLVM_CCACHE_BUILD=$(LLVM_CCACHE_BUILD) \
					-DLLVM_CCACHE_DIR=$(LLVM_CCACHE_DIR) \
					-DLLVM_CCACHE_MAXSIZE=$(LLVM_CCACHE_MAXSIZE) \
					-DLLVM_ENABLE_ASSERTIONS=$(LLVM_ENABLE_ASSERTIONS)
		cmake --build $(LLVM_SOURCE_PATH)/build

build-llc:
		make LLVM_ENABLE_PROJECTS="llc" build
		./$(LLVM_SOURCE_PATH)/build/bin/llc --version

build-clang:
		make LLVM_ENABLE_PROJECTS="clang" build
		./$(LLVM_SOURCE_PATH)/build/bin/clang --version