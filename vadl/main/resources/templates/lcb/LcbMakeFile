TARGET="[(${namespace})]"

CMAKE_CXX_STANDARD="14"
LLVM_SOURCE_PATH="llvm-final"

ifndef LLVM_PARALLEL_COMPILE_JOBS
		LLVM_PARALLEL_COMPILE_JOBS=16
endif
ifndef LLVM_PARALLEL_LINK_JOBS
		LLVM_PARALLEL_LINK_JOBS=8
endif
ifndef LLVM_ENABLE_PROJECTS
		LLVM_ENABLE_PROJECTS="clang"
endif
ifndef LLVM_SOURCE_PATH
		$(error LLVM_SOURCE_PATH is not set)
endif
ifndef LLVM_CMAKE_BUILD_TYPE
		LLVM_CMAKE_BUILD_TYPE="MinSizeRel"
endif
ifndef LLVM_ENABLE_ASSERTIONS
		LLVM_ENABLE_ASSERTIONS=On
endif

LLVM_CCACHE_BUILD=1

default: build

.PHONY: build

build:
		git clone https://github.com/llvm/llvm-project --depth=1 -b llvmorg-17.0.6 $(LLVM_SOURCE_PATH) || true
		cp -r ./llvm/* $(LLVM_SOURCE_PATH)/llvm
		cp -r ./clang/* $(LLVM_SOURCE_PATH)/clang
		cp -r ./lld/* $(LLVM_SOURCE_PATH)/lld
		mkdir -p $(LLVM_SOURCE_PATH)/build
		cmake -GNinja -S $(LLVM_SOURCE_PATH)/llvm -B $(LLVM_SOURCE_PATH)/build \
					-DCMAKE_BUILD_TYPE=$(LLVM_CMAKE_BUILD_TYPE) \
					-DCMAKE_CXX_STANDARD=$(CMAKE_CXX_STANDARD) \
					-DLLVM_ENABLE_PROJECTS="$(LLVM_ENABLE_PROJECTS)" \
					-DLLVM_TARGETS_TO_BUILD="" \
					-DLLVM_EXPERIMENTAL_TARGETS_TO_BUILD="$(TARGET)" \
					-DLLVM_PARALLEL_COMPILE_JOBS=$(LLVM_PARALLEL_COMPILE_JOBS) \
					-DLLVM_PARALLEL_LINK_JOBS=$(LLVM_PARALLEL_LINK_JOBS) \
					-DLLVM_CCACHE_BUILD=$(LLVM_CCACHE_BUILD) \
					-DLLVM_ENABLE_ASSERTIONS=$(LLVM_ENABLE_ASSERTIONS) \
					-DCMAKE_C_COMPILER_LAUNCHER=/opt/sccache/sccache \
					-DCMAKE_CXX_COMPILER_LAUNCHER=/opt/sccache/sccache
		cmake --build $(LLVM_SOURCE_PATH)/build

build-llc:
		make LLVM_ENABLE_PROJECTS="llc" build
		./$(LLVM_SOURCE_PATH)/build/bin/llc --version

build-clang:
		make LLVM_ENABLE_PROJECTS="clang" build
		./$(LLVM_SOURCE_PATH)/build/bin/clang --version
